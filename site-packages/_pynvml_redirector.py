# SPDX-FileCopyrightText: Copyright (c) 2025 NVIDIA CORPORATION & AFFILIATES. All rights reserved.
# SPDX-License-Identifier: BSD-2-Clause

import importlib
import importlib.abc
import sys
import warnings

import_msg = (
    "The pynvml package is deprecated. Please install nvidia-ml-py instead. "
    "If you did not install pynvml directly, please report this to the maintainers of "
    "the package that installed pynvml for you."
)


class PynvmlFinder(importlib.abc.MetaPathFinder):
    def __init__(self):
        self.has_warned = False

    def find_spec(self, name, path, target=None):
        if name.startswith("pynvml") and not self.has_warned:
            warnings.warn(import_msg, FutureWarning, stacklevel=2)
            self.has_warned = True
            for finder in sys.meta_path:
                try:
                    spec = finder.find_spec(name, path, target)
                except AttributeError:
                    # Finders written to a pre-Python 3.4 spec for finders will
                    # not implement find_spec. We can skip those altogether.
                    continue
                else:
                    if spec is not None:
                        return spec


finder = PynvmlFinder()
sys.meta_path.insert(0, finder)
